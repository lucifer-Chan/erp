<div class="erp_content animated fadeInRight full_height"  id="employee_page">
    <div class="panel panel-default width240 full_height" style="float: left;margin-right: 15px;">
        <div class="panel-heading">
            <div>
                <button type="button" class="btn btn-success btn-xs _new">新增部门</button>
                <button type="button" class="btn btn-warning btn-xs _modify">修改名称</button>
                <button type="button" class="btn btn-danger btn-xs _delete">删除部门</button>
            </div>
        </div>
        <div class="panel-body">
            <div id="orgTree" class="ztree"></div>
        </div>
    </div>

    <div class="full_height">

        <div id="searchFilter">
            <div class="sidebar-search"><div name="fastSearchByNumberForm" id="fastSearchByNumberForm"><div class="input-group"><input type="text" class="form-control" id="fastKeyword" placeholder="姓名、登录名、电话号码" autocomplete="off"><span class="input-group-btn"><button class="btn btn-default" type="button" id="searchIcon"><i class="fa fa-search"></i></button></span></div></div></div>
            <button type="button" class="btn btn-success btn-ms right" style="margin: 0px 15px 0px 20px;" id="addUserBt" data-toggle="modal" data-target="#_newEmployee">新增人员</button>
        </div>
        <div class="pd23 pd43">
            <div class="row">
                <div class="pTable">
                    <div class="pTable-content customTable">
                        <table class="table table-hover" id="dataTables">
                            <thead>
                                <tr erp-id="aaa_{id}">
                                    <th style="width:50px" erp-data="{name}">姓名</th>
                                    <th style="width:50px" erp-data="{loginName}">登录名</th>
                                    <th style="width:50px" erp-data="{mobile}">电话号码</th>
                                    <th style="width:85px" erp-data="{departmentNames}" erp-convert="sub20">部门</th>
                                    <th style="width:60px" erp-data="{menuNames}" erp-convert="sub20">权限</th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- 修改名称 -->
<div class="modal fade" role="dialog" id="_modifyDepartment">
    <div class="modal-dialog" role="document" style="z-index: 1040">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true"><i class="fa fa-remove"></i></span></button>
                <h4 class="modal-title"><i class="fa defaultColor"></i> 修改部门名称</h4>
            </div>
            <div class="modal-body">
                <div class="row">
                    <form class="form-horizontal pd210 pd410">
                        <div class="row pd42 pd22">
                            <div class="col-sm-12">
                                <div class="cell pd32">
                                    <p class="inline middle title pd21">部门名称</p>
                                    <p class="inline middle nr" style="width: 300px"><input type="text" class="form-control" placeholder="输入部门名称" name="name" onfocus="checkStrNum(this,10)" oninput="checkStrNum(this,10)"></p>
                                    <button type="button" class="btn btn-info noborder" id="_modifyDepartmentBt">提交</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- 新建部门名称 -->
<div class="modal fade" role="dialog" id="_newDepartment">
    <div class="modal-dialog" role="document" style="z-index: 1040">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true"><i class="fa fa-remove"></i></span></button>
                <h4 class="modal-title"><i class="fa defaultColor"></i> 新增子部门</h4>
            </div>
            <div class="modal-body">
                <div class="row">
                    <form class="form-horizontal pd210 pd410">
                        <div class="row pd42 pd22">
                            <div class="col-sm-12">
                                <div class="cell pd32">
                                    <p class="inline middle title pd21">部门名称</p>
                                    <p class="inline middle nr" style="width: 300px"><input type="text" class="form-control" placeholder="输入部门名称" name="name" onfocus="checkStrNum(this,10)" oninput="checkStrNum(this,10)"></p>
                                    <button type="button" class="btn btn-info noborder" id="_newDepartmentBt">提交</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 新建人员model -->
<div class="modal fade myErpModal" id="_newEmployee" role="dialog" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog" role="document" style="z-index: 1050">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true"><i class="fa fa-remove black"></i></span></button>
                <h4 class="modal-title"><i class="fa defaultColor"></i> 新增人员</h4>
            </div>
            <div class="modal-body">
                <!-- Nav tabs -->
                <ul class="nav nav-tabs noborder" role="tablist">
                    <li role="presentation" class="active"><span>基本信息</span></li>
                    <li role="presentation"><span>组织信息</span></li>
                    <li role="presentation"><span>权限信息</span></li>
                    <!--<li role="presentation" class="active"><span href="#_baseNewInfo" aria-controls="_baseNewInfo" role="tab" data-toggle="tab">基本信息</span></li>-->
                    <!--<li role="presentation"><span href="#_orgNewInfo" aria-controls="_orgNewInfo" role="tab" data-toggle="tab">组织信息</span></li>-->
                    <!--<li role="presentation"><span href="#_menuNewInfo" aria-controls="_menuNewInfo" role="tab" data-toggle="tab">权限信息</span></li>-->
                </ul>
                <!-- Tab panes -->
                <div class="tab-content">
                    <div role="tabpanel" class="tab-pane active" id="_baseNewInfo">
                        <div class="row">
                            <form class="form-horizontal">
                                <div class="form-group">
                                    <label class="col-sm-3 control-label">姓名</label>
                                    <div class="col-sm-9">
                                        <input type="text" class="form-control" name="name" placeholder="最多输入10个字符" autofocus onfocus="checkStrNum(this,30)" oninput="checkStrNum(this,30)">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-3 control-label">登录名</label>
                                    <div class="col-sm-9">
                                        <input type="text" class="form-control" name="loginName" placeholder="最多输入20个字符" onfocus="checkStrNum(this,20)" oninput="checkStrNum(this,20)">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-3 control-label">手机</label>
                                    <div class="col-sm-9">
                                        <input type="text" class="form-control" name="mobile" placeholder="联系电话" onfocus="checkStrNum(this,11)" oninput="checkStrNum(this,11)">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-3 control-label">密码</label>
                                    <div class="col-sm-9">
                                        <input type="text" class="form-control" name="password" placeholder="最多输入20个字符" onfocus="checkStrNum(this,20)" oninput="checkStrNum(this,20)">
                                    </div>
                                </div>
                                <div class="modal-footer noborder">
                                    <div class="btn btn-info" name="next" role="tab" nav-to="1" href="#_orgNewInfo">下一步</div>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div role="tabpanel" class="tab-pane projectSetting" id="_orgNewInfo">
                        <div class="_org"></div>
                        <div class="modal-footer noborder">
                            <div class="btn btn-info" name="previous" role="tab"  nav-to="0" href="#_baseNewInfo">上一步</div>
                            <div class="btn btn-info" name="next" role="tab" nav-to="2" href="#_menuNewInfo">下一步</div>
                        </div>
                    </div>
                    <div role="tabpanel" class="tab-pane projectSetting" id="_menuNewInfo">
                        <div class="_menu"></div>
                        <div class="modal-footer noborder">
                            <div class="btn btn-info" name="previous" role="tab" nav-to="1" href="#_orgNewInfo">上一步</div>
                            <div class="btn btn-info" name="save">保存</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- 右侧-->
<div class="rightInfoPage animated fadeOutRightBig" id="rightInfoPage">
    <div class="bugInfoTop">
        <em class="fa fa-angle-right rightInfoBack" alt="隐藏" title="隐藏"></em>
        <span class="btn0">
            <button class="btn btn-primary" type="button" data-action="common">修改基本信息</button>
            <button class="btn btn-primary" type="button" data-action="department">修改所属部门</button>
            <button class="btn btn-primary" type="button" data-action="menu">修改权限</button>
        </span>
    </div>
    <div class="bugInfoContent employeeDetail">
        <div class="panel-default bugInfo">
            <div class="row">
                <p class="pd23 pd43">
                            <span class="col-xs-6 pd0">
                               <span class="label label-info">基本信息</span>
                            </span>
                    <span class="col-xs-6  pd21 text-right" style="font-size: 18px">
                                <i class="fa defaultColor cursor fa-angle-double-up" title="收起" alt="收起" data-value="base"></i>
                            </span>
                </p>
                <div class="col-xs-12" data-value="baseInfo">
                    <div class="pd43">
                        <div class="row">
                            <div class="col-xs-6">
                                <label class="col-xs-4 pd0">姓名</label>
                                <div class="col-xs-8 txt pd0">陈露青</div>
                            </div>
                            <div class="col-xs-6">
                                <label class="col-xs-4 pd0">条形码</label>
                                <div class="col-xs-8 txt pd0">UE00000001526</div>
                            </div>

                        </div>
                        <div class="row">
                            <div class="col-xs-6">
                                <label class="col-xs-4 pd0">登录名</label>
                                <div class="col-xs-8 txt pd0">Lucifer.Chan</div>
                            </div>
                            <div class="col-xs-6">
                                <label class="col-xs-4 pd0">联系电话</label>
                                <div class="col-xs-8 txt pd0">13306500517</div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-xs-6">
                                <label class="col-xs-4 pd0">创建时间</label>
                                <div class="col-xs-8 txt pd0">2018-05-19 20:21:04</div>
                            </div>
                            <div class="col-xs-6">
                                <label class="col-xs-4 pd0">密码</label>
                                <div class="col-xs-8 txt pd0"><span class="label label-danger">未设置</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <hr>
            <div class="row">
                <p class="pd23 pd43">
                    <span class="col-xs-6 pd0">
                       <span class="label label-info">部门信息</span>
                    </span>
                    <span class="col-xs-6  pd21 text-right" style="font-size: 18px">
                        <i class="fa defaultColor cursor fa-angle-double-up" title="收起" alt="收起" data-value="department"></i>
                    </span>
                </p>
                <div class="col-xs-12" data-value="departmentInfo">
                    <h5 class="pd43">
                        <span class="md32 border-radius label label-default">开发部</span>
                        <span class="md32 border-radius label label-default">开发部</span>
                        <span class="md32 border-radius label label-default">开发部</span>
                        <span class="md32 border-radius label label-default">开发啊部</span>
                        <span class="md32 border-radius label label-default">开开发部部</span>
                        <span class="md32 border-radius label label-default">开发部开发部</span>
                        <span class="md32 border-radius label label-default">原材料仓储部</span>
                        <span class="md32 border-radius label label-default">开发部</span>
                        <span class="md32 border-radius label label-default">开发部</span>
                        <span class="md32 border-radius label label-default">开发部</span>
                        <span class="md32 border-radius label label-default">开发部</span>
                        <span class="md32 border-radius label label-default">开发部</span>
                        <span class="md32 border-radius label label-default">开发部</span>
                    </h5>
                </div>
            </div>
            <hr>
            <div class="row">
                <p class="pd23 pd43">
                    <span class="col-xs-6 pd0">
                       <span class="label label-info">权限信息</span>
                    </span>
                    <span class="col-xs-6  pd21 text-right">
                        <i class="fa defaultColor cursor fa-angle-double-up" title="收起" alt="收起" data-value="menu"></i>
                    </span>
                </p>
                <div class="col-xs-12" data-value="menuInfo">
                    <h5 class="pd43">
                        <span class="md32 border-radius label label-default">开发部</span>
                        <span class="md32 border-radius label label-default">开发部</span>
                        <span class="md32 border-radius label label-default">开发部</span>
                        <span class="md32 border-radius label label-default">开发啊部</span>
                        <span class="md32 border-radius label label-default">开开发部部</span>
                        <span class="md32 border-radius label label-default">开发部开发部</span>
                        <span class="md32 border-radius label label-default">原材料仓储部</span>
                        <span class="md32 border-radius label label-default">开发部</span>
                        <span class="md32 border-radius label label-default">开发部</span>
                        <span class="md32 border-radius label label-default">开发部</span>
                        <span class="md32 border-radius label label-default">开发部</span>
                        <span class="md32 border-radius label label-default">开发部</span>
                        <span class="md32 border-radius label label-default">开发部</span>
                    </h5>
                </div>
            </div>
            <hr>
            <div>
                <ul class="nav nav-tabs noborder" role="tablist">
                    <li role="presentation" class="active"><span href="#saleLog" aria-controls="saleLog" role="tab" data-toggle="tab">销售日志</span></li>
                    <li role="presentation"><span href="#produceLog" aria-controls="produceLog" role="tab" data-toggle="tab">生产日志</span></li>
                    <li role="presentation"><span href="#purchaseLog" aria-controls="purchaseLog" role="tab" data-toggle="tab">采购日志</span></li>
                </ul>
                <!-- Tab panes -->
                <div class="tab-content">
                    <div role="tabpanel" class="pd43 tab-pane active" id="saleLog">
                        <p>显示销售日志。</p>
                        <p>显示销售日志。</p>
                        <p>显示销售日志。</p>
                    </div>
                    <div role="tabpanel" class="pd43 tab-pane" id="produceLog">
                        <p>显示销售日志。</p>
                        <p>显示销售日志。</p>
                        <p>显示销售日志。</p>
                        <p>显示销售日志。</p>
                    </div>
                    <div role="tabpanel" class="pd43 tab-pane" id="purchaseLog">
                        <p>显示采购日志。</p>
                        <p>显示销售日志。</p><p>显示销售日志。</p>
                        <p>显示销售日志。</p>
                        <p>显示销售日志。</p>
                        <p>显示销售日志。</p>
                        <p>显示销售日志。</p><p>显示销售日志。</p><p>显示销售日志。</p><p>显示销售日志。</p><p>显示销售日志。</p><p>显示销售日志。</p><p>显示销售日志。</p><p>显示销售日志。</p><p>显示销售日志。</p><p>显示销售日志。</p>




                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
</div>

<script type="text/javascript">
    requirejs(['ztree','utils','services'],function (ztree, utils, services) {
        console.log('Hello');

        $('.bugInfo').slimScroll({
            height: '100%',
            railOpacity: 0.9
        });

        init();

        var consts = {
            nodeKey : '_current_department_node_'
            , treeObj : null//组织树
            , leaves : []//组织树叶子节点
            , menus : []//可操作的菜单-权限
            , $modifyDnModal : $('#_modifyDepartment')//修改部门名称的modal
            , $modifyDnBt : $('#_modifyDepartmentBt')//修改部门名称的提交按钮
            , $modifyDnInput : $('#_modifyDepartment').find('input[name="name"]')//修改部门名称的输入框

            , $newDnModal : $('#_newDepartment')//新增部门名称的modal
            , $newDnBt : $('#_newDepartmentBt')//新增部门名称的提交按钮
            , $newDnInput : $('#_newDepartment').find('input[name="name"]')//新增部门名称的输入框

            , editEmployeeModal : $('#_newEmployee')//编辑人员的modal
            , selectedEmployeeId : ''//选中的员工id
        };

        /**
         * 加载用户数据
         * @param oParams 参数
         */
        function loadEmployeeData(oParams) {

            /**
             * 加载数据的实际方法
             * @param params
             */
            function promiseEmployeeData(params){
                return services.account.query(params);
            }

            /**
             * 选中行事件
             * @param $tr 选中的行事件
             */
            function fClickTr($tr){
                console.log($tr);
                $('#rightInfoPage').show().attr('class', 'rightInfoPage animated fadeInRightBig');
            }

            /**
             * 客户化方法，字符串长度大于20时截取
             * @param array 待包装的数据
             */
            function sub20(array){
                var value = array.length ? array[0] : '';
                return !value ? '<span class="label label-warning">未分配</span>' : value.length >= 20 ? value.substr(0, 17) + '...' : value;
            }

            utils.dataTable({
                holder: '#dataTables'
                , $dataProvider : promiseEmployeeData
                , oParams : oParams || {}
                , fClickTr : fClickTr
                , aConverts : [sub20]
            });
            // utils.dataTable('#dataTables', loadData, {name : '丁'}, fClickTr, [fIdConvert]);
        }

        /**
         * 组织树的操作按钮
         */
        function buttonOptStyle(){
            if (!$.session(consts.nodeKey)){
                $('._modify, ._delete, ._new').addClass('disabled');
            } else if(-1 === $.session(consts.nodeKey).id){
                $('._modify, ._delete').addClass('disabled');
                $('._new').removeClass('disabled');
            } else {
                $('._modify, ._delete, ._new').removeClass('disabled');
            }
        }

        /**
         *  画圈圈
         *  all - 全部的单选项 [{id, name|code}]
         *  selected - 选中的 [id]
         *  _format - {idKey, nameKey}
         *  return - html(string)
         */
        function drawCircles(all, selected, _format) {
            var format = $.extend({}, {idKey : 'id', nameKey : 'name'}, _format);
            selected = selected || [];
            var html = '';
            for(var i = 0; i < all.length; i ++){
                if(i%2 === 0)
                    html += '<div class="row">';
                html += ('<label class="col-sm-3 control-label" style="padding-top: 1px;margin-bottom: 0px">{'+ format.nameKey +'}</label>' +
                    '<div class="col-sm-1"><span data-value="true"><i id="{'+ format.idKey + '}" class="fa fa-circle-o"></i></span></div>')
                    .replace('{' + format.nameKey + '}', all[i][format.nameKey])
                    .replace('{' + format.idKey + '}', all[i][format.idKey]);
                if(i%2 === 0)
                    html += '<div class="col-sm-4"></div>';
                if(i%2 === 1)
                    html += '</div>';
            }

            if(all.length%2 === 1)
                html += '</div>';
            var $html = $(html);

            $html.find('i').each(function(){
                var $i = $(this);
                selected.forEach(function (id){
                    $i.attr('id') == id && $i.removeClass('fa-circle-o').addClass('fa-dot-circle-o');
                })
            }).unbind('click').click(function () {
                if($(this).hasClass('fa-circle-o'))
                    $(this).removeClass('fa-circle-o').addClass('fa-dot-circle-o');
                else
                    $(this).removeClass('fa-dot-circle-o').addClass('fa-circle-o');
            });

            return $html;
        }

        /**
         * 事件初始化
         */
        function initEvent() {
            //模态框初始化-修改部门名称
            consts.$modifyDnModal.on('show.bs.modal', function () {
                consts.$modifyDnInput.val($.session(consts.nodeKey).name);
            });
            //模态框初始化-新增部门
            consts.$newDnModal.on('show.bs.modal', function () {
                consts.$newDnInput.val('');
            });
            //模态框初始化-编辑用户
            consts.editEmployeeModal.on('show.bs.modal', function () {
                $('#_orgNewInfo').find('._org').html(drawCircles(consts.leaves));
                $('#_menuNewInfo').find('._menu').html(drawCircles(consts.menus, [], {idKey : 'code'}));
                //默认选中第一个tab
                $(this).find('div[name="previous"]').eq(0).click();
            });
            //模态框隐藏-编辑用户
            consts.editEmployeeModal.on('hidden.bs.modal', function (e) {
                //清理数据
                $(this).find('input[type="text"]').val('');
                consts.selectedEmployeeId = '';
            });

            //编辑用户
            consts.editEmployeeModal.find('div[role="tab"]').unbind('click').click(function (e) {
                var $button = $(this);
                e.preventDefault();
                var $modal = consts.editEmployeeModal;
                var to = $(this).attr('nav-to');
                //下一步-上一步
                function step() {
                    $modal.find('li[role="presentation"]').eq(to).addClass('active').siblings().removeClass('active');
                    $button.tab('show');

                }
                //tab的active属性

                //保存事件
                if($button.attr('name') !== 'next'){
                    step();
                } else if('1' === to){
                    //基本信息
                    services.account.create({
                        name : $modal.find('input[name="name"]').val(),
                        loginName : $modal.find('input[name="loginName"]').val(),
                        password : $modal.find('input[name="password"]').val(),
                        mobile : $modal.find('input[name="mobile"]').val()
                    })
                    .then(function (ret) {
                        consts.selectedEmployeeId = ret.id;
                        $('#fastKeyword').val('');
                        loadEmployeeData();
                        step();
                    })
                    .catch(function (reason) {
                        layer.msg(reason.caught ? reason.message : '修改用户基本信息失败！');
                    })
                } else {
                    //部门
                    var departmentIds = [];
                    $('#_orgNewInfo').find('.fa-dot-circle-o').each(function () {
                        console.log($(this));
                        departmentIds.push($(this).attr('id'));
                    });
                    console.log(departmentIds);
                    services.account
                        .saveDepartments(consts.selectedEmployeeId, departmentIds)
                        .then(function () {
                            loadEmployeeData();
                            step();
                        })
                        .catch(function (reason) {
                            layer.msg(reason.caught ? reason.message : '保存组织关联失败！');
                        })
                }
            });

            //保存权限
            consts.editEmployeeModal.find('div[name="save"]').unbind('click').click(function () {
                var menuCodes = [];
                $('#_menuNewInfo').find('.fa-dot-circle-o').each(function () {
                    menuCodes.push($(this).attr('id'));
                });
                services.account
                    .saveMenus(consts.selectedEmployeeId, menuCodes)
                    .then(function () {
                        loadEmployeeData();
                        consts.editEmployeeModal.modal('hide');
                    })
                    .catch(function (reason) {
                        layer.msg(reason.caught ? reason.message : '保存权限关联失败！');
                    });
            });




            //修改部门名称提交
            consts.$modifyDnBt.unbind('click').click(function () {
                var node = $.session(consts.nodeKey);
                services.department.modify(node.id, consts.$modifyDnInput.val())
                    .then(function (ret) {
                        consts.$modifyDnModal.modal('hide');
                        layer.msg(ret._message);
                    })
                    .catch(function (reason) {
                        layer.msg(reason.caught ? reason.message : '修改部门名称失败！');
                    })
                    .then(function () {
                        initDepartments();
                    })
                ;
            });

            //新增部门名称
            consts.$newDnBt.unbind('click').click(function () {
                var node = $.session(consts.nodeKey) || {};
                services.department.create({
                    name : consts.$newDnInput.val(),
                    parentId : node.id
                })
                .then(function (ret) {
                    consts.$newDnModal.modal('hide');
                    layer.msg(ret._message);
                })
                .catch(function (reason) {
                    layer.msg(reason.caught ? reason.message : '新增部门名称失败！');
                })
                .then(function () {
                    initDepartments();
                })
            });


            //部门增删改操作
            $('._modify, ._delete, ._new').unbind('click').click(function () {
                if($(this).hasClass('disabled')) return;
                if(!$.session(consts.nodeKey)) {
                    layer.msg('请先选择组织树节点');
                    return;
                }
                if($(this).hasClass('_modify'))
                    consts.$modifyDnModal.modal('toggle');
                if($(this).hasClass('_new'))
                    consts.$newDnModal.modal('toggle');
                if($(this).hasClass('_delete')){
                    layer.confirm('删除此部门将会删除他的所有从属部门及人员管理，确定删除吗？',{title:'提示',move:false},function(){
                        services.department.delete($.session(consts.nodeKey).id)
                            .then(function (ret) {
                                layer.msg(ret._message);
                            })
                            .catch(function (reason) {
                                layer.msg(reason.caught ? reason.message : '删除部门名称失败！');
                            })
                            .then(function () {
                                initDepartments();
                            })
                    });
                }
            });

            //搜索图标
            $('#searchIcon').unbind('click').click(function(){
                loadEmployeeData({ cause : $('#fastKeyword').val() });
            });

            $("#fastKeyword").keydown(function(e){
                if(e.keyCode === 13)
                    loadEmployeeData({ cause : $('#fastKeyword').val() });
            });

            // //新增人员
            // $('#addUserBt').unbind('click').click(function () {
            //     alert('点击新增人员')
            // })
        }

        /**
         * 初始化组织树
         */
        function initDepartments() {
            var treeSetting = {
                data: {
                    simpleData: {
                        enable: true,
                        idKey: "id",
                        pIdKey: "parentId",
                        rootPId: 0
                    }
                },

                callback: {
                    onClick: function (event, treeId, treeNode) {
                        $.session(consts.nodeKey, treeNode);
                        buttonOptStyle();
                        loadEmployeeData({departmentId : treeNode.id < 0 ? '' : treeNode.id});
                    }
                }
            };

            function leaves(treeNode) {
                if (treeNode.isParent) {
                    var childrenNodes = treeNode.children;
                    if (childrenNodes) {
                        for (var i = 0; i < childrenNodes.length; i++) {
                            if (!childrenNodes[i].isParent) {
                                consts.leaves.push(childrenNodes[i]);
                            } else {
                                consts.leaves = leaves(childrenNodes[i], consts.leaves);
                            }
                        }
                    }
                }
                return consts.leaves;
            }

            return services.department.all()
                .then(function (ret) {
                    ret.all.push({name : '组织结构', id : -1});
                    consts.treeObj = $.fn.zTree.init($("#orgTree"), treeSetting, ret.all);
                    consts.treeObj.expandAll(true);
                    leaves(consts.treeObj.getNodeByTId('orgTree_1'), consts.leaves);
                    console.log(consts.leaves);
                    $.session(consts.nodeKey, null);
                    buttonOptStyle();
                })
                .catch(function (reason) {
                    layer.msg(reason.caught ? reason.message : '初始化组织结构失败！');
                })
                .then(function () {
                    return services.menus.children();
                })
                .then(function (ret) {
                    consts.menus = ret.list;
                })
                .catch(function (reason) {
                    layer.msg(reason.caught ? reason.message : '获取菜单失败！');
                })

                ;
        }

        /**
         * 页面初始化
         */
        function init() {
            initDepartments()
                .then(function () {
                    initEvent();
                    loadEmployeeData();
                });
        }
    });
</script>