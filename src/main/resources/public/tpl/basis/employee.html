<div class="erp_content animated fadeInRight full_height"  id="employee_page">
    <div class="panel panel-default width240 full_height" style="float: left;margin-right: 15px;">
        <div class="panel-heading">
            <div>
                <button type="button" class="btn btn-success btn-xs _new">新增组织</button>
                <button type="button" class="btn btn-warning btn-xs _modify">修改名称</button>
                <button type="button" class="btn btn-danger btn-xs _delete">删除组织</button>
            </div>
        </div>
        <div class="panel-body">
            <div id="orgTree" class="ztree"></div>
        </div>
    </div>

    <div class="full_height">
        <div id="searchFilter">
            <div class="sidebar-search">
                <div name="fastSearchByNumberForm" id="fastSearchByNumberForm"><div class="input-group"><input type="text" class="form-control" id="fastKeyword" placeholder="姓名、登录名、电话号码、编号" autocomplete="off"><span class="input-group-btn"><button class="btn btn-default" type="button" id="searchIcon"><i class="fa fa-search"></i></button></span></div></div>
            </div>
        </div>
        <div class="sidebar-operations">
            <button type="button" class="btn btn-default btn-ms operation" id="addUserBt" data-toggle="modal" data-target="#_newEmployee">新增人员</button>
        </div>
        <div class="pd23 pd43">
            <div class="row">
                <div class="pTable">
                    <div class="pTable-content customTable">
                        <table class="table table-hover" id="dataTables">
                            <thead>
                                <tr erp-id="{id}">
                                    <th style="width:70px" erp-data="{barCode}">编号<span id="allCount"></span></th>
                                    <th style="width:40px" erp-data="{name}">姓名</th>
                                    <th style="width:40px" erp-data="{loginName}">登录名</th>
                                    <th style="width:50px" erp-data="{mobile}">电话号码</th>
                                    <th style="width:70px" erp-data="{departmentNames}" erp-convert="sub20">组织</th>
                                    <th style="width:70px" erp-data="{menuNames}" erp-convert="sub20">权限</th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- 修改名称 -->
<div class="modal fade" role="dialog" id="_modifyDepartment">
    <div class="modal-dialog" role="document" style="z-index: 1040">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true"><i class="fa fa-remove"></i></span></button>
                <h4 class="modal-title"><i class="fa fa-edit defaultColor"></i> 修改组织名称</h4>
            </div>
            <div class="modal-body">
                <div class="row">
                    <form class="form-horizontal pd210 pd410">
                        <div class="row pd42 pd22">
                            <div class="col-sm-12">
                                <div class="cell pd32">
                                    <p class="inline middle title pd21">组织名称</p>
                                    <p class="inline middle nr" style="width: 300px"><input type="text" class="form-control" placeholder="输入组织名称" name="name" onfocus="checkStrNum(this,10)" oninput="checkStrNum(this,10)"></p>
                                    <button type="button" class="btn btn-info noborder" id="_modifyDepartmentBt">提交</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- 新建组织名称 -->
<div class="modal fade" role="dialog" id="_newDepartment">
    <div class="modal-dialog" role="document" style="z-index: 1040">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true"><i class="fa fa-remove"></i></span></button>
                <h4 class="modal-title"><i class="fa fa-plus defaultColor"></i> 新增子组织</h4>
            </div>
            <div class="modal-body">
                <div class="row">
                    <form class="form-horizontal pd210 pd410">
                        <div class="row pd42 pd22">
                            <div class="col-sm-12">
                                <div class="cell pd32">
                                    <p class="inline middle title pd21">组织名称</p>
                                    <p class="inline middle nr" style="width: 300px"><input type="text" class="form-control" placeholder="输入组织名称" name="name" onfocus="checkStrNum(this,10)" oninput="checkStrNum(this,10)"></p>
                                    <button type="button" class="btn btn-info noborder" id="_newDepartmentBt">提交</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- 新建人员model -->
<div class="modal fade myErpModal" id="_newEmployee" role="dialog" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog" role="document" style="z-index: 1050">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true"><i class="fa fa-remove black"></i></span></button>
                <h4 class="modal-title"><i class="fa fa-edit defaultColor"></i> 新增人员</h4>
            </div>
            <div class="modal-body">
                <!-- Nav tabs -->
                <ul class="nav nav-tabs noborder" role="tablist">
                    <li role="presentation" class="active"><span>基本信息</span></li>
                    <li role="presentation"><span>组织信息</span></li>
                    <li role="presentation"><span>权限信息</span></li>
                </ul>
                <!-- Tab panes -->
                <div class="tab-content">
                    <div role="tabpanel" class="tab-pane active" id="_baseNewInfo">
                        <div class="row">
                            <form class="form-horizontal">
                                <div class="form-group">
                                    <label class="col-sm-3 control-label">姓名</label>
                                    <div class="col-sm-9">
                                        <input type="text" class="form-control" name="name" placeholder="最多输入10个字符" autofocus onfocus="checkStrNum(this,30)" oninput="checkStrNum(this,30)">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-3 control-label">登录名</label>
                                    <div class="col-sm-9">
                                        <input type="text" class="form-control" name="loginName" placeholder="最多输入20个字符" onfocus="checkStrNum(this,20)" oninput="checkStrNum(this,20)">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-3 control-label">手机</label>
                                    <div class="col-sm-9">
                                        <input type="text" class="form-control" name="mobile" placeholder="联系电话" onfocus="checkStrNum(this,11)" oninput="checkStrNum(this,11)">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-3 control-label">密码</label>
                                    <div class="col-sm-9">
                                        <input type="text" class="form-control" name="password" placeholder="最多输入20个字符" onfocus="checkStrNum(this,20)" oninput="checkStrNum(this,20)">
                                    </div>
                                </div>
                                <div class="modal-footer noborder">
                                    <div class="btn btn-info" name="next" role="tab" nav-to="1" href="#_orgNewInfo">下一步</div>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div role="tabpanel" class="tab-pane projectSetting" id="_orgNewInfo">
                        <div class="_org"></div>
                        <div class="modal-footer noborder">
                            <div class="btn btn-info" name="previous" role="tab"  nav-to="0" href="#_baseNewInfo">上一步</div>
                            <div class="btn btn-info" name="next" role="tab" nav-to="2" href="#_menuNewInfo">下一步</div>
                        </div>
                    </div>
                    <div role="tabpanel" class="tab-pane projectSetting" id="_menuNewInfo">
                        <div class="_menu"></div>
                        <div class="modal-footer noborder">
                            <div class="btn btn-info" name="previous" role="tab" nav-to="1" href="#_orgNewInfo">上一步</div>
                            <div class="btn btn-info" name="save">保存</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- 修改人员基本信息 -->
<div class="modal fade" role="dialog" id="updateUserBaseInfoModal">
    <div class="modal-dialog" role="document" style="z-index: 1040">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true"><i class="fa fa-remove"></i></span></button>
                <h4 class="modal-title"><i class="fa fa-user defaultColor"></i> 修改基本信息</h4>
            </div>
            <div class="modal-body">
                <form class="form-horizontal pd210 pd410">
                    <div class="form-group">
                        <label class="col-sm-3 control-label">姓名</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" name="name" placeholder="最多输入10个字符" autofocus onfocus="checkStrNum(this,30)" oninput="checkStrNum(this,30)">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 control-label">登录名</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" name="loginName" placeholder="最多输入20个字符" onfocus="checkStrNum(this,20)" oninput="checkStrNum(this,20)">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 control-label">手机</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" name="mobile" placeholder="联系电话" onfocus="checkStrNum(this,11)" oninput="checkStrNum(this,11)">
                        </div>
                    </div>
                    <div class="modal-footer noborder">
                        <button class="btn btn-info noborder" name="save">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<!--修改员工组织-->
<div class="modal fade myErpModal" role="dialog" id="updateDepartmentModal">
    <div class="modal-dialog" role="document" style="z-index: 1040">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true"><i class="fa fa-remove"></i></span></button>
                <h4 class="modal-title"><i class="fa fa-cogs defaultColor"></i> 修改组织信息</h4>
            </div>
            <div class="modal-body">
                <div class="pd210 pd410 projectSetting">
                    <div class="_org"></div>
                    <div class="modal-footer noborder">
                        <button class="btn btn-info noborder" name="save">保存</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!--修改员工权限-->
<div class="modal fade myErpModal" role="dialog" id="updateMenuModal">
    <div class="modal-dialog" role="document" style="z-index: 1040">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true"><i class="fa fa-remove"></i></span></button>
                <h4 class="modal-title"><i class="fa fa-unlock-alt defaultColor"></i> 修改权限信息</h4>
            </div>
            <div class="modal-body">
                <div class="pd210 pd410 projectSetting">
                    <div class="_menu"></div>
                    <div class="modal-footer noborder">
                        <button class="btn btn-info" name="save">保存</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!--修改小程序权限-->
<div class="modal fade myErpModal" role="dialog" id="updateMiniRoleModal">
    <div class="modal-dialog" role="document" style="z-index: 1040">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true"><i class="fa fa-remove"></i></span></button>
                <h4 class="modal-title"><i class="fa fa-unlock-alt defaultColor"></i> 修改权限信息</h4>
            </div>
            <div class="modal-body">
                <div class="pd210 pd410 projectSetting">
                    <div class="_miniRoles"></div>
                    <div class="modal-footer noborder">
                        <button class="btn btn-info" name="save">保存</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
updateMin

<!-- 右侧-->
<div class="rightInfoPage animated fadeOutRightBig" id="rightInfoPage">
    <div class="bugInfoTop">
        <em class="fa fa-angle-right rightInfoBack" alt="隐藏" title="隐藏"></em>
        <span class="btn0 _operations">
            <button class="btn btn-primary" data-toggle="modal" data-target="#updateUserBaseInfoModal">修改基本信息</button>
            <button class="btn btn-primary" data-toggle="modal" data-target="#updateDepartmentModal">修改所属组织</button>
            <button class="btn btn-primary" data-toggle="modal" data-target="#updateMenuModal">修改权限</button>
            <button class="btn btn-primary" data-toggle="modal" data-target="#updateMiniRoleModal">编辑小程序权限</button>
            <button class="btn btn-primary" data-toggle="modal" data-target="#resetUserPasswordModal">重置密码</button>
            <button class="btn btn-primary" data-name="delete">删除</button>
            <button class="btn btn-primary" data-name="printEmployeeInfo">打印工牌</button>
        </span>
    </div>
    <div class="bugInfoContent employeeDetail">
        <div class="panel-default bugInfo">
            <div class="row">
                <p class="pd23 pd43">
                    <span class="col-xs-6 pd0">
                        <span class="label label-info">基本信息</span>
                    </span>
                    <span class="col-xs-6  pd21 text-right" style="font-size: 18px">
                        <i class="fa defaultColor cursor fa-angle-double-up" title="收起" alt="收起" data-value="base"></i>
                    </span>
                </p>
                <div class="col-xs-12" data-value="baseInfo">
                    <div class="pd43">
                        <div class="row">
                            <div class="col-xs-6">
                                <label class="col-xs-4 pd0">姓名</label>
                                <div class="col-xs-8 txt pd0" data-name="name"></div>
                            </div>
                            <div class="col-xs-6">
                                <label class="col-xs-4 pd0">编号</label>
                                <div class="col-xs-8 txt pd0" data-name="barCode"></div>
                            </div>

                        </div>
                        <div class="row">
                            <div class="col-xs-6">
                                <label class="col-xs-4 pd0">登录名</label>
                                <div class="col-xs-8 txt pd0" data-name="loginName"></div>
                            </div>
                            <div class="col-xs-6">
                                <label class="col-xs-4 pd0">联系电话</label>
                                <div class="col-xs-8 txt pd0" data-name="mobile"></div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-xs-6">
                                <label class="col-xs-4 pd0">创建时间</label>
                                <div class="col-xs-8 txt pd0" data-name="createdAt"></div>
                            </div>
                            <div class="col-xs-6">
                                <label class="col-xs-4 pd0">密码</label>
                                <div class="col-xs-8 txt pd0" data-status></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <hr>
            <div class="row">
                <p class="pd23 pd43">
                    <span class="col-xs-6 pd0">
                       <span class="label label-info">组织信息</span>
                    </span>
                    <span class="col-xs-6  pd21 text-right" style="font-size: 18px">
                        <i class="fa defaultColor cursor fa-angle-double-up" title="收起" alt="收起" data-value="department"></i>
                    </span>
                </p>
                <div class="col-xs-12" data-value="departmentInfo">
                    <h5 class="pd43"></h5>
                </div>
            </div>
            <hr>
            <div class="row">
                <p class="pd23 pd43">
                    <span class="col-xs-6 pd0">
                       <span class="label label-info">权限信息</span>
                    </span>
                    <span class="col-xs-6  pd21 text-right">
                        <i class="fa defaultColor cursor fa-angle-double-up" title="收起" alt="收起" data-value="menu"></i>
                    </span>
                </p>
                <div class="col-xs-12" data-value="menuInfo">
                    <h5 class="pd43"></h5>
                </div>
            </div>
            <div class="row">
                <p class="pd23 pd43">
                    <span class="col-xs-6 pd0">
                       <span class="label label-info">小程序权限信息</span>
                    </span>
                    <span class="col-xs-6  pd21 text-right">
                        <i class="fa defaultColor cursor fa-angle-double-up" title="收起" alt="收起" data-value="menu"></i>
                    </span>
                </p>
                <div class="col-xs-12" data-value="miniRoleInfo">
                    <h5 class="pd43"></h5>
                </div>
            </div>
            <hr>
            <div>
                <ul class="nav nav-tabs noborder" role="tablist">
                    <li role="presentation" class="active"><span href="#saleLog" aria-controls="saleLog" role="tab" data-toggle="tab">销售日志</span></li>
                    <li role="presentation"><span href="#produceLog" aria-controls="produceLog" role="tab" data-toggle="tab">生产日志</span></li>
                    <li role="presentation"><span href="#purchaseLog" aria-controls="purchaseLog" role="tab" data-toggle="tab">采购日志</span></li>
                </ul>
                <!-- Tab panes -->
                <div class="tab-content">
                    <div role="tabpanel" class="pd43 tab-pane active" id="saleLog">
                        <div class="col-sm-12 bugInfoHistories"></div>
                    </div>
                    <div role="tabpanel" class="pd43 tab-pane" id="produceLog">
                        <div class="col-sm-12 bugInfoHistories"></div>
                    </div>
                    <div role="tabpanel" class="pd43 tab-pane" id="purchaseLog">
                        <div class="col-sm-12 bugInfoHistories"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
</div>
<!-- 重置密码 -->
<div class="modal fade" id="resetUserPasswordModal" role="dialog">
    <div class="modal-dialog" role="document" style="z-index: 1040">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true"><i class="fa fa-remove"></i></span></button>
                <h4 class="modal-title"><i class="fa fa-key defaultColor"></i> 重置密码</h4>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="form-horizontal pd210 pd410">
                        <div class="row pd42 pd22">
                            <div class="col-sm-12">
                                <div class="cell pd32">
                                    <p class="inline middle title pd21">密码</p>
                                    <p class="inline middle nr" style="width: 300px"><input type="text" class="form-control" placeholder="输入密码" name="password" onfocus="checkStrNum(this,20)" oninput="checkStrNum(this,20)"></p>
                                    <button class="btn btn-info noborder" name="save">保存</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="employee_print_holder" style="width: 400px" hidden></div>

<!-- 员工订单模版 -->
<script id="template-emp-order" type="text/template">
    {{if orders.length}}
    {{each orders as order}}
    <p>
        <span class="name"><b>{{order.statusName}}</b></span>
        <span class="content">【{{order.barCode}}】 {{order.description}}</span>
        <span class="right">{{order.createdAt}}</span>
    </p>
    {{/each}}
    {{else}}
    <p>暂无</p>
    {{/if}}
</script>

<script type="text/javascript">
    requirejs(['ztree','utils','services'],function (ztree, utils, services) {
        console.log('starting at employee.html');
        init();
        var consts = {
            nodeKey : '_current_department_node_'
            , treeObj : null//组织树
            , leaves : []//组织树叶子节点
            , menus : []//可操作的菜单-权限
            , miniRoles : []//所有的小程序权限
            , selectedEmployee : {} //选中的员工
            , oQueryParam : {}//查询参数

            , $modifyDnModal : $('#_modifyDepartment')//修改组织名称的modal
            , $modifyDnBt : $('#_modifyDepartmentBt')//修改组织名称的提交按钮
            , $modifyDnInput : $('#_modifyDepartment').find('input[name="name"]')//修改组织名称的输入框

            , $updateBaseInfoModal : $('#updateUserBaseInfoModal')//修改员工基本信息
            , $resetPasswordModal : $('#resetUserPasswordModal')//重设员工密码
            , $updateDepartmentModal : $('#updateDepartmentModal')//更新员工组织
            , $updateMenuModal : $('#updateMenuModal')//更新员工权限
            , $updateMiniRoleModal : $('#updateMiniRoleModal')//编辑小程序权限

            , $newDnModal : $('#_newDepartment')//新增组织名称的modal
            , $newDnBt : $('#_newDepartmentBt')//新增组织名称的提交按钮
            , $newDnInput : $('#_newDepartment').find('input[name="name"]')//新增组织名称的输入框
            , $editEmployeeModal : $('#_newEmployee')//编辑人员的modal
            , $rightPage : $('#rightInfoPage')//右侧页面
        };

        /**
         * 加载用户数据
         * @param oParams 参数
         */
        function loadDataTable(oParams) {
            //缓存查询条件
            if (oParams === true){
                oParams = consts.oQueryParam;
            } else {
                consts.oQueryParam = oParams;
            }

            /**
             * 加载数据的实际方法
             * @param params
             */
            function dataProvider(params){
                return services.account.query(params);
            }

            /**
             * 选中行事件
             * @param $tr 选中的行事件
             */
            function fClickTr($tr){
                var $rightPage = consts.$rightPage;
                var id = $tr.attr('id');
                if (id === $rightPage.attr('data-id')) return;
                $rightPage.attr('data-id', id);
                services.account.one(id)
                    .then(function (employee) {
                        initEmployeeDetail(employee);
                        $rightPage.show().attr('class', 'rightInfoPage animated fadeInRightBig');
                        $rightPage.find('.fa-angle-double-down').click();
                    })
                    .catch(function (reason) {
                        layer.msg(reason.caught ? reason.message : '请求失败！');
                    });
            }

            /**
             * 客户化方法，字符串长度大于20时截取
             * @param array 待包装的数据
             */
            function sub20(array){
                var value = array.length ? array[0] : '';
                return !value ? '<span class="label label-warning">未分配</span>' : value.length >= 20 ? value.substr(0, 17) + '...' : value;
            }

            utils.dataTable({
                holder: '#dataTables'
                , $dataProvider : dataProvider
                , oParams : oParams || {}
                , fClickTr : fClickTr
                , aConverts : [sub20]
                , unSorting : [0,1,2,3,4,5]
            });
        }

        /**
         * 根据用户信息初始化右侧页面
         */
        function initEmployeeDetail(employee) {
            console.log('员工', employee);
            consts.selectedEmployee = employee;
            var unSetting = '<span class="label label-danger">未设置</span>';
            var $detail = $('.employeeDetail');
            var $baseInfo = $detail.find('div[data-value="baseInfo"]');
            var $departmentInfo = $detail.find('div[data-value="departmentInfo"] h5');
            var $menuInfo = $detail.find('div[data-value="menuInfo"] h5');
            var $miniRoleInfo = $detail.find('div[data-value="miniRoleInfo"] h5')
            //初始化页面数据-基本信息
            $baseInfo.find('div[data-name]').each(function () {
                $(this).html(employee[$(this).attr('data-name')] || unSetting);
            });
            $baseInfo.find('div[data-status]').html(
                employee.status === "1" ? '<span class="label label-success">已设置</span>' : unSetting
            );
            //初始化页面数据-组织信息
            $departmentInfo.empty();
            var departmentNames = employee.departmentNames;
            if(!departmentNames.length){
                $departmentInfo.html(unSetting);
            } else {
                departmentNames.split(',').forEach(function (name) {
                    $departmentInfo.append('<span class="md32 border-radius label label-default">' + name + '</span>');
                })
            }
            //初始化页面数据-权限信息
            $menuInfo.html('');
            var menuNames = employee.menuNames;
            if(!menuNames.length){
                $menuInfo.html(unSetting);
            } else {
                menuNames.split(',').forEach(function (name) {
                    $menuInfo.append('<span class="md32 border-radius label label-default">' + name + '</span>');
                })
            }
            //初始化页面数据-小程序权限
            $miniRoleInfo.html('');
            var miniRoleNames = employee.miniRoleNames;
            if(!miniRoleNames.length){
                $miniRoleInfo.html(unSetting);
            } else {
                miniRoleNames.split(',').forEach(function (name) {
                    $miniRoleInfo.append('<span class="md32 border-radius label label-default">' + name + '</span>');
                })
            }

            //初始化订单操作
            services.account.orders(employee.id)
                .then(function (ret) {
                    $('#saleLog').find('.bugInfoHistories').html(template('template-emp-order', { orders : ret.sale || []}));
                    $('#produceLog').find('.bugInfoHistories').html(template('template-emp-order', { orders : ret.prod || []}));
                    $('#purchaseLog').find('.bugInfoHistories').html(template('template-emp-order', { orders : ret.purchase || []}));

                });
        }

        /**
         * 组织树的操作按钮
         */
        function buttonOptStyle(){
            if (!$.session(consts.nodeKey)){
                $('._modify, ._delete, ._new').addClass('disabled');
            } else if(-1 === $.session(consts.nodeKey).id){
                $('._modify, ._delete').addClass('disabled');
                $('._new').removeClass('disabled');
            } else {
                $('._modify, ._delete, ._new').removeClass('disabled');
            }
        }

        /**
         *  画圈圈
         *  all - 全部的单选项 [{id, name|code}]
         *  selected - 选中的 [id]
         *  _format - {idKey, nameKey}
         *  return - html(string)
         */
        function drawCircles(all, selected, _format) {
            var format = $.extend({}, {idKey : 'id', nameKey : 'name'}, _format);
            selected = selected || [];
            var html = '';
            for(var i = 0; i < all.length; i ++){
                if(i%2 === 0)
                    html += '<div class="row">';
                html += '<label class="col-sm-3 control-label" style="padding-top: 1px;margin-bottom: 0px">'+ all[i][format.nameKey] +'</label>' +
                    '<div class="col-sm-1"><span data-value="true"><i id="'+ all[i][format.idKey] + '" class="fa fa-circle-o"></i></span></div>';
                if(i%2 === 0)
                    html += '<div class="col-sm-4"></div>';
                if(i%2 === 1)
                    html += '</div>';
            }

            if(all.length%2 === 1)
                html += '</div>';
            var $html = $(html);

            $html.find('i').each(function(){
                var $i = $(this);
                selected.forEach(function (id){
                    $i.attr('id') == id && $i.removeClass('fa-circle-o').addClass('fa-dot-circle-o');
                })
            }).unbind('click').click(function () {
                if($(this).hasClass('fa-circle-o'))
                    $(this).removeClass('fa-circle-o').addClass('fa-dot-circle-o');
                else
                    $(this).removeClass('fa-dot-circle-o').addClass('fa-circle-o');
            });
            return $html;
        }

        /**
         * 事件初始化
         */
        function initEvent() {
            //模态框初始化-修改组织名称
            consts.$modifyDnModal.on('show.bs.modal', function () {
                consts.$modifyDnInput.val($.session(consts.nodeKey).name);
            });
            //模态框初始化-新增组织
            consts.$newDnModal.on('show.bs.modal', function () {
                consts.$newDnInput.val('');
            });
            //模态框初始化-编辑用户
            consts.$editEmployeeModal.on('show.bs.modal', function () {
                //清理数据
                $(this).find('input[type="text"]').val('');
                consts.selectedEmployee = {};
                $('#_orgNewInfo').find('._org').html(drawCircles(consts.leaves));
                $('#_menuNewInfo').find('._menu').html(drawCircles(consts.menus, [], {idKey : 'code'}));
                //默认选中第一个tab
                $(this).find('div[name="previous"]').eq(0).click();
            });

            //模态框-更新用户基本信息
            consts.$updateBaseInfoModal.on('show.bs.modal', function () {
                $(this).find('input[name="name"]').val(consts.selectedEmployee.name||'');
                $(this).find('input[name="loginName"]').val(consts.selectedEmployee.loginName||'');
                $(this).find('input[name="mobile"]').val(consts.selectedEmployee.mobile ||'');
            });
            //模态框-重设密码
            consts.$resetPasswordModal.on('show.bs.modal', function () {
                $(this).find('input[name="password"]').val('');
            });
            //模态框-更新组织
            consts.$updateDepartmentModal.on('show.bs.modal', function () {
                $(this).find('._org').html(drawCircles(consts.leaves, consts.selectedEmployee.departmentIds));
            });
            //模态框-更新权限
            consts.$updateMenuModal.on('show.bs.modal', function () {
                $(this).find('._menu').html(drawCircles(consts.menus, consts.selectedEmployee.menuCodes, {idKey : 'code'}));
            });
            //模态框-更新小程序权限
            consts.$updateMiniRoleModal.on('show.bs.modal', function () {
                $(this).find('._miniRoles').html(drawCircles(consts.miniRoles, consts.selectedEmployee.miniRoleCodes, {idKey : 'code'}));
            });

            //更新用户基本信息操作
            consts.$updateBaseInfoModal.find('button[name="save"]').unbind('click').click(function (e) {
                e.preventDefault();
                var $modal = consts.$updateBaseInfoModal;
                services.account.update({
                    id : consts.selectedEmployee.id
                    , name : $modal.find('input[name="name"]').val()
                    , loginName : $modal.find('input[name="loginName"]').val()
                    , mobile : $modal.find('input[name="mobile"]').val()
                }).then(function (employee) {
                    loadDataTable(true);
                    initEmployeeDetail(employee);
                    $modal.modal('hide');
                }).catch(function (reason) {
                    layer.msg(reason.caught ? reason.message : '修改用户基本信息失败！');
                });
            });
            //更新用户密码操作
            consts.$resetPasswordModal.find('button[name="save"]').unbind('click').click(function () {
                var $modal = consts.$resetPasswordModal;
                services.account
                    .updatePassword(consts.selectedEmployee.id, $modal.find('input[name="password"]').val())
                    .then(function (employee) {
                        loadDataTable(true);
                        initEmployeeDetail(employee);
                        $modal.modal('hide');
                    })
                    .catch(function (reason) {
                        layer.msg(reason.caught ? reason.message : '重设密码失败！');
                    });
            });
            //更新用户组织操作
            consts.$updateDepartmentModal.find('button[name="save"]').unbind('click').click(function () {
                var $modal = consts.$updateDepartmentModal;
                var departmentIds = [];
                $modal.find('.fa-dot-circle-o').each(function () {
                    console.log($(this));
                    departmentIds.push($(this).attr('id'));
                });
                services.account
                    .saveDepartments(consts.selectedEmployee.id, departmentIds)
                    .then(function (employee) {
                        loadDataTable(true);
                        initEmployeeDetail(employee);
                        $modal.modal('hide');
                    })
                    .catch(function (reason) {
                        layer.msg(reason.caught ? reason.message : '保存组织关联失败！');
                    });
            });
            //更新用户权限操作
            consts.$updateMenuModal.find('button[name="save"]').unbind('click').click(function () {
                var $modal = consts.$updateMenuModal;
                var menuCodes = [];
                $modal.find('.fa-dot-circle-o').each(function () {
                    menuCodes.push($(this).attr('id'));
                });
                services.account
                    .saveMenus(consts.selectedEmployee.id, menuCodes)
                    .then(function (employee) {
                        loadDataTable(true);
                        initEmployeeDetail(employee);
                        $modal.modal('hide');
                    })
                    .catch(function (reason) {
                        layer.msg(reason.caught ? reason.message : '保存权限关联失败！');
                    });
            });


            //更新用户小程序权限操作
            consts.$updateMiniRoleModal.find('button[name="save"]').unbind('click').click(function () {
                var $modal = consts.$updateMiniRoleModal;
                var miniRoleCodes = [];
                $modal.find('.fa-dot-circle-o').each(function () {
                    miniRoleCodes.push($(this).attr('id'));
                });
                services.account
                    .saveMiniRoles(consts.selectedEmployee.id, miniRoleCodes)
                    .then(function (employee) {
                        loadDataTable(true);
                        initEmployeeDetail(employee);
                        $modal.modal('hide');
                    })
                    .catch(function (reason) {
                        layer.msg(reason.caught ? reason.message : '保存小程序权限关联失败！');
                    });
            });

            //删除用户操作
            consts.$rightPage.find('._operations ').find('button[data-name="delete"]').unbind('click').click(function () {
                layer.confirm('删除此组织将会删除他的所有从属组织及人员管理，确定删除吗？',{title:'提示',move:false},function(){
                    services.account.delete(consts.selectedEmployee.id)
                        .then(function (ret) {
                            layer.msg(ret._message);
                            loadDataTable(true);
                            consts.selectedEmployee = {};
                            consts.$rightPage.hide();
                        })
                        .catch(function (reason) {
                            layer.msg(reason.caught ? reason.message : '请求失败！');
                        });
                });
            });

            //打印工牌
            consts.$rightPage.find('._operations').find('button[data-name="printEmployeeInfo"]').unbind('click').click(function () {
                var employee = consts.selectedEmployee;
                console.log('当前员工', employee);

                var data = $.extend({}, employee);
                services.common.barcode(data.barCode)
                    .then(function (ret) {
                        data.base64 = ret.base64;
                    })
                    .then(function () {
                        var html = template("employee_print_tpl", data);
                        var $clone = $('#employee_print_holder').clone();
                        $clone.html(html).show().print();
                    })
                    .catch(function () {
                        layer.msg('生成条形码失败！');
                    });
            });


            //编辑用户
            consts.$editEmployeeModal.find('div[role="tab"]').unbind('click').click(function (e) {
                var $button = $(this);
                e.preventDefault();
                var $modal = consts.$editEmployeeModal;
                var to = $(this).attr('nav-to');
                //下一步-上一步
                function step() {
                    $modal.find('li[role="presentation"]').eq(to).addClass('active').siblings().removeClass('active');
                    $button.tab('show');

                }
                //保存事件
                if($button.attr('name') !== 'next'){
                    step();
                } else if('1' === to){
                    //基本信息
                    services.account.create({
                        name : $modal.find('input[name="name"]').val(),
                        loginName : $modal.find('input[name="loginName"]').val(),
                        password : $modal.find('input[name="password"]').val(),
                        mobile : $modal.find('input[name="mobile"]').val()
                    })
                    .then(function (ret) {
                        consts.selectedEmployee = ret;
                        $('#fastKeyword').val('');
                        loadDataTable();
                        step();
                    })
                    .catch(function (reason) {
                        layer.msg(reason.caught ? reason.message : '新增用户失败！');
                    })
                } else {
                    //组织
                    var departmentIds = [];
                    $('#_orgNewInfo').find('.fa-dot-circle-o').each(function () {
                        console.log($(this));
                        departmentIds.push($(this).attr('id'));
                    });
                    console.log(departmentIds);
                    services.account
                        .saveDepartments(consts.selectedEmployee.id, departmentIds)
                        .then(function () {
                            loadDataTable();
                            step();
                        })
                        .catch(function (reason) {
                            layer.msg(reason.caught ? reason.message : '保存组织关联失败！');
                        });
                }
            });
            //保存权限
            consts.$editEmployeeModal.find('div[name="save"]').unbind('click').click(function () {
                var menuCodes = [];
                $('#_menuNewInfo').find('.fa-dot-circle-o').each(function () {
                    menuCodes.push($(this).attr('id'));
                });
                services.account
                    .saveMenus(consts.selectedEmployee.id, menuCodes)
                    .then(function () {
                        loadDataTable();
                        consts.$editEmployeeModal.modal('hide');
                    })
                    .catch(function (reason) {
                        layer.msg(reason.caught ? reason.message : '保存权限关联失败！');
                    });
            });
            //修改组织名称提交
            consts.$modifyDnBt.unbind('click').click(function () {
                var node = $.session(consts.nodeKey);
                services.department.modify(node.id, consts.$modifyDnInput.val())
                    .then(function (ret) {
                        consts.$modifyDnModal.modal('hide');
                        layer.msg(ret._message);
                    })
                    .catch(function (reason) {
                        layer.msg(reason.caught ? reason.message : '修改组织名称失败！');
                    })
                    .then(function () {
                        initDepartments();
                    });
            });
            //新增组织名称
            consts.$newDnBt.unbind('click').click(function () {
                var node = $.session(consts.nodeKey) || {};
                services.department.create({
                    name : consts.$newDnInput.val(),
                    parentId : node.id
                })
                .then(function (ret) {
                    consts.$newDnModal.modal('hide');
                    layer.msg(ret._message);
                })
                .catch(function (reason) {
                    layer.msg(reason.caught ? reason.message : '新增组织名称失败！');
                })
                .then(function () {
                    initDepartments();
                });
            });
            //组织增删改操作
            $('._modify, ._delete, ._new').unbind('click').click(function () {
                if($(this).hasClass('disabled')) return;
                if(!$.session(consts.nodeKey)) {
                    layer.msg('请先选择组织树节点');
                    return;
                }
                if($(this).hasClass('_modify'))
                    consts.$modifyDnModal.modal('toggle');
                if($(this).hasClass('_new'))
                    consts.$newDnModal.modal('toggle');
                if($(this).hasClass('_delete')){
                    layer.confirm('删除此组织将会删除他的所有从属组织及人员管理，确定删除吗？',{title:'提示',move:false},function(){
                        services.department.delete($.session(consts.nodeKey).id)
                            .then(function (ret) {
                                layer.msg(ret._message);
                            })
                            .catch(function (reason) {
                                layer.msg(reason.caught ? reason.message : '删除组织名称失败！');
                            })
                            .then(function () {
                                initDepartments();
                            });
                    });
                }
            });

            //搜索
            utils.bindQuery(function (value) {
                loadDataTable({cause : value});
            });
        }

        /**
         * 初始化组织树
         */
        function initDepartments() {
            var treeSetting = {
                data: {
                    simpleData: {
                        enable: true,
                        idKey: "id",
                        pIdKey: "parentId",
                        rootPId: 0
                    }
                },

                callback: {
                    onClick: function (event, treeId, treeNode) {
                        $.session(consts.nodeKey, treeNode);
                        buttonOptStyle();
                        loadDataTable({departmentId : treeNode.id < 0 ? '' : treeNode.id});
                    }
                }
            };

            function leaves(treeNode) {
                if (treeNode.children) {
                    var childrenNodes = treeNode.children;
                    if (childrenNodes) {
                        for (var i = 0; i < childrenNodes.length; i++) {
                            if (!childrenNodes[i].children) {
                                consts.leaves.push(childrenNodes[i]);
                            } else {
                                consts.leaves = leaves(childrenNodes[i]);
                            }
                        }
                    }
                }
                return consts.leaves;
            }


            return services.department.all()
                .then(function (ret) {
                    ret.all.push({name : '组织结构', id : -1});
                    ret.all.forEach(function (node) {
                        node['isParent'] = true;
                        console.log(node);
                    })
                    consts.treeObj = $.fn.zTree.init($("#orgTree"), treeSetting, ret.all);
                    consts.treeObj.expandAll(true);
                    leaves(consts.treeObj.getNodeByTId('orgTree_1'));
                    console.log(consts.leaves);
                    $.session(consts.nodeKey, null);
                    buttonOptStyle();
                })
                .catch(function (reason) {
                    layer.msg(reason.caught ? reason.message : '初始化组织结构失败！');
                })
                .then(function () {
                    return services.menus.children();
                })
                .then(function (ret) {
                    consts.menus = ret.list;
                })
                .catch(function (reason) {
                    layer.msg(reason.caught ? reason.message : '获取菜单失败！');
                })
                .then(function () {
                    return services.common.miniRoles();
                })
                .then(function (ret) {
                    consts.miniRoles = ret.list;
                })
                ;
        }

        /**
         * 页面初始化
         */
        function init() {
            $('.bugInfo').slimScroll({ height: '100%', railOpacity: 0.9 });
            initDepartments().then(function () {
                initEvent();
                loadDataTable();
            });
        }
    });
</script>